#' Plot genomes, features and synteny maps
#'
#' @param data genome layout generated by `layout_genomes()`
#' @param theme choose a gggenomes default theme, NULL to omit.
#' @param scale choose a gggenomes dafault y-scale, NULL to omit.
#' @inheritParams ggplot2::ggplot
#' @param ... currently not used
#' @importFrom ggplot2 ggplot
#' @export
#' @return ggplot object
gggenomes <- function(data = NULL, mapping = aes(),
    scale = c("lab", "numlab", NULL), scale_args = list(),
    theme = c("clean", NULL), theme_args = list(),
    ..., environment = parent.frame()){

    if(!any(class(data) == "tbl_genomes")) data <- as_tbl_genomes(data)

    p <- ggplot(data = data, mapping = mapping, environment = environment)

    if(!is.null(theme)){ # add theme
        theme <- match.arg(theme)
        p <- p + do.call(paste0("theme_gggenomes_", theme), theme_args)
    }

    if(!is.null(scale)){ # add sca;e
        scale <- match.arg(scale)
        scale_args$data <- data
        p <- p + do.call(paste0("scale_gggenomes_", scale), scale_args)
    }

    class(p) <- c('gggenomes', class(p))
    p
}

#' ggplot.default tries to `fortify(data)` and we don't want that
#'
#' @export
ggplot.tbl_genomes <- function(data, mapping = aes(), ...,
                               environment = parent.frame()) {
  if (!missing(mapping) && !inherits(mapping, "uneval")) {
    stop("Mapping should be created with `aes() or `aes_()`.", call. = FALSE)
  }

  p <- structure(list(
    data = data,
    layers = list(),
    scales = ggplot2:::scales_list(),
    mapping = mapping,
    theme = list(),
    coordinates = coord_cartesian(default = TRUE),
    facet = facet_null(),
    plot_env = environment
  ), class = c("gg", "ggplot"))

  p$labels <- ggplot2:::make_labels(mapping)

  ggplot2:::set_last_plot(p)
  p
}

#' gggenomes default theme
#' @importFrom ggplot2 theme_bw
#' @importFrom ggplot2 theme
#' @export
theme_gggenomes_clean <- function(...){
    theme_bw() + theme(
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.ticks.y=element_blank()) +
            theme(...)
}
#' y scale with genome labels
#'
#' @name scale_gggenomes
NULL

#' @rdname scale_gggenomes
#' @import ggplot2
#' @export
scale_gggenomes_lab <- function(data, ...){
    breaks <- unique(expose(data)$gix)
    labels <- unique(expose(data)$gid)
    limits <- c(max(breaks) + .5, min(breaks) -.5)
    scale_y_continuous("", limits = limits, breaks = breaks,
        labels = labels, trans = scales::reverse_trans(), ...)
}
#' @rdname scale_gggenomes
#' @export
scale_gggenomes_numlab <- function(data, ...){
    breaks <- unique(expose(data)$gix)
    labels <- paste("[", breaks, "] ", unique(expose(data)$gid), sep="")
    limits <- c(max(breaks) + .5, min(breaks) -.5)
    scale_y_continuous("", limits = limits, breaks = breaks,
        labels = labels, trans = scales::reverse_trans(), ...)
}
